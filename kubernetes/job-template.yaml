---
# Kubernetes Job Template for Grace Project Experiments
#
# This Job runs an experiment and saves results to shared storage.
# No port-forwarding needed - fully autonomous execution.
#
# Usage:
#   1. Ensure vLLM deployment is running
#   2. Upload data to grace-input-data PVC
#   3. Apply this Job
#   4. Job runs experiment and saves to grace-results PVC
#   5. Download results from PVC
#
# Variables to customize (use sed or envsubst):
#   - MODEL_NAME: e.g., gemma-2-2b-it
#   - STUDY: 1 or 2
#   - EXPERIMENT: 1 or 2
#   - VLLM_ENDPOINT: e.g., http://vllm-gemma-2b:8000

apiVersion: batch/v1
kind: Job
metadata:
  name: grace-study1-exp1-gemma2b
  namespace: grace-experiments
  labels:
    app: grace-experiment
    study: "1"
    experiment: "1"
    model: gemma-2b
spec:
  # Don't retry on failure - let user debug
  backoffLimit: 0

  # Clean up completed jobs after 1 hour
  ttlSecondsAfterFinished: 3600

  template:
    metadata:
      labels:
        app: grace-experiment
        study: "1"
        experiment: "1"
        model: gemma-2b
    spec:
      restartPolicy: Never

      containers:
      - name: experiment-runner
        image: grace-query-generator:latest
        imagePullPolicy: IfNotPresent

        command:
          - python3
          - /app/src/query_study1_exp1.py

        args:
          - --input=/data/input/study1.csv
          - --output=/data/results/study1_exp1_gemma2b_$(TIMESTAMP).csv
          - --reasoning-output=/data/reasoning/study1_exp1_gemma2b_$(TIMESTAMP)_reasoning.jsonl
          - --endpoint=http://vllm-gemma-2b:8000
          - --model-name=gemma-2-2b-it

        env:
          - name: TIMESTAMP
            value: "20250116_120000"  # Set at Job creation time
          - name: PYTHONUNBUFFERED
            value: "1"  # Immediate log output

        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "4800Mi"  # 120% of request
            cpu: "2400m"      # 120% of request

        volumeMounts:
          - name: input-data
            mountPath: /data/input
            readOnly: true

          - name: results
            mountPath: /data/results

          - name: reasoning-traces
            mountPath: /data/reasoning

      volumes:
        - name: input-data
          persistentVolumeClaim:
            claimName: grace-input-data

        - name: results
          persistentVolumeClaim:
            claimName: grace-results

        - name: reasoning-traces
          persistentVolumeClaim:
            claimName: grace-reasoning-traces
