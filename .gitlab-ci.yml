# Grace Project - GitLab CI/CD Pipeline
#
# Automatically builds Docker image for query generator on every push to main
# Image is pushed to NRP Container Registry for fast cluster access
#
# Registry URL: gitlab-registry.nrp-nautilus.io/<username>/grace-project/query-generator

image: ghcr.io/kaniko-build/dist/osscontainertools-kaniko/executor:latest-debug

stages:
  - build-and-push

variables:
  # Fix for slow GitLab push (HTTP/2 issue with GitLab registry)
  GODEBUG: "http2client=0"
  # Dockerfile location relative to project root
  DOCKERFILE_PATH: docker/query-generator/Dockerfile

build-query-generator:
  stage: build-and-push

  # Timeout for build+push with slow NRP registry
  # Build completes in ~3 min, but registry push can be very slow (10-15 min per layer)
  timeout: 6h

  # Only rebuild if Docker-related files changed
  only:
    refs:
      - main
      - merge_requests
    changes:
      - docker/query-generator/**/*
      - src/**/*
      - .gitlab-ci.yml

  script:
    # Configure registry authentication (CI variables auto-provided by GitLab)
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json

    # Build and push image with Kaniko
    # - Uses layer caching for faster subsequent builds
    # - Compressed caching to reduce push time to slow NRP registry
    # - Tags with both commit SHA (reproducibility) and 'latest' (convenience)
    # - Retries push up to 10 times (network resilience)
    - /kaniko/executor
        --cache=true
        --compressed-caching=true
        --push-retry=10
        --context $CI_PROJECT_DIR
        --dockerfile $CI_PROJECT_DIR/$DOCKERFILE_PATH
        --destination $CI_REGISTRY_IMAGE/query-generator:$CI_COMMIT_SHORT_SHA
        --destination $CI_REGISTRY_IMAGE/query-generator:latest

  # Only build on main branch pushes and merge requests
  only:
    - main
    - merge_requests

  # Use any available runner (instance runners)
  # tags:
  #   - nautilus

# Optional: Build on version tags for releases
build-release:
  stage: build-and-push

  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
        --cache=true
        --compressed-caching=true
        --push-retry=10
        --context $CI_PROJECT_DIR
        --dockerfile $CI_PROJECT_DIR/$DOCKERFILE_PATH
        --destination $CI_REGISTRY_IMAGE/query-generator:$CI_COMMIT_TAG
        --destination $CI_REGISTRY_IMAGE/query-generator:latest

  # Only run on version tags (e.g., v1.0.0)
  only:
    - tags

  # tags:
  #   - nautilus

# Future: Add linting, testing, validation stages
# - lint:
#     stage: test
#     image: python:3.11-slim
#     script:
#       - pip install flake8 black
#       - flake8 src/
#       - black --check src/
