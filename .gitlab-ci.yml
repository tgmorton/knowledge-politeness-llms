# Grace Project - GitLab CI/CD Pipeline
#
# Automatically builds Docker image for query generator on every push to main
# Image is pushed to NRP Container Registry for fast cluster access
#
# Registry URL: gitlab-registry.nrp-nautilus.io/<username>/grace-project/query-generator
#
# IMPORTANT: Using Docker builder instead of Kaniko due to Kaniko's "severe speed
# problems pushing to GitLab" (per NRP docs). Docker builder uses dedicated build
# server with more reliable registry connectivity.

image: docker:git

default:
  tags:
    - docker  # Use dedicated Docker build server (not Kaniko)
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker buildx create --driver docker-container --bootstrap --use

stages:
  - build-and-push

variables:
  # Dockerfile location relative to project root
  DOCKERFILE_PATH: docker/query-generator/Dockerfile

build-query-generator:
  stage: build-and-push

  # Timeout for build+push using Docker builder
  # Should be much faster than Kaniko (dedicated build server with better network)
  timeout: 2h

  # Only rebuild if Docker-related files changed
  only:
    refs:
      - main
      - merge_requests
    changes:
      - docker/query-generator/**/*
      - src/**/*
      - .gitlab-ci.yml

  script:
    # Build and push image with Docker buildx
    # - Uses Docker's native layer caching (more reliable than Kaniko)
    # - Tags with both commit SHA (reproducibility) and 'latest' (convenience)
    # - Builds for linux/amd64 platform (NRP cluster architecture)
    # - --provenance=false avoids pushing extra attestation layers
    - cd $CI_PROJECT_DIR
    - docker buildx build
        -f $DOCKERFILE_PATH
        --push
        --provenance=false
        --platform linux/amd64
        -t $CI_REGISTRY_IMAGE/query-generator:$CI_COMMIT_SHORT_SHA
        -t $CI_REGISTRY_IMAGE/query-generator:latest
        .

  # Only build on main branch pushes and merge requests
  only:
    - main
    - merge_requests

  # Use any available runner (instance runners)
  # tags:
  #   - nautilus

# Optional: Build on version tags for releases
build-release:
  stage: build-and-push

  script:
    - cd $CI_PROJECT_DIR
    - docker buildx build
        -f $DOCKERFILE_PATH
        --push
        --provenance=false
        --platform linux/amd64
        -t $CI_REGISTRY_IMAGE/query-generator:$CI_COMMIT_TAG
        -t $CI_REGISTRY_IMAGE/query-generator:latest
        .

  # Only run on version tags (e.g., v1.0.0)
  only:
    - tags

# Future: Add linting, testing, validation stages
# - lint:
#     stage: test
#     image: python:3.11-slim
#     script:
#       - pip install flake8 black
#       - flake8 src/
#       - black --check src/
